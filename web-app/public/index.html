<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä–æ–≤</title>
    <script>
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL API –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –≥–¥–µ –∑–∞–ø—É—â–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        function getApiBaseUrl() {
            // –ï—Å–ª–∏ –º—ã –Ω–∞ —Ç–æ–º –∂–µ –¥–æ–º–µ–Ω–µ, —á—Ç–æ –∏ API (–≤ Docker), –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏
            // –ï—Å–ª–∏ accessed —á–µ—Ä–µ–∑ IP/–¥–æ–º–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π —Ö–æ—Å—Ç
            const hostname = window.location.hostname;
            const port = window.location.port;
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
                return {
                    session: 'http://localhost:8000',
                    ticket: 'http://localhost:8001', 
                    payment: 'http://localhost:8002'
                };
            } else {
                // –£–¥–∞–ª–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø (—á–µ—Ä–µ–∑ nginx proxy –∏–ª–∏ IP)
                const protocol = window.location.protocol;
                const base = `${protocol}//${hostname}${port ? ':' + port : ''}`;
                return {
                    session: base,
                    ticket: base,
                    payment: base
                };
            }
        }

        const apiUrls = getApiBaseUrl();
        const API_BASE = apiUrls.session;
        const TICKET_API_BASE = apiUrls.ticket;
        const PAYMENT_API_BASE = apiUrls.payment;
        let currentRole = 'visitor';
        let selectedSession = null;
        let cart = [];
        let cinemas = [];
        let sessions = [];
        let halls = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            setupEventListeners();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            try {
                const [cinemasRes, sessionsRes, hallsRes] = await Promise.all([
                    fetch(`${API_BASE}/api/session/cinemas`, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`${API_BASE}/api/session/sessions`, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`${API_BASE}/api/session/halls`, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                cinemas = await cinemasRes.json();
                sessions = await sessionsRes.json();
                halls = await hallsRes.json();

                updateCinemaSelects();
                if (currentRole === 'visitor') {
                    loadVisitorSessions();
                } else {
                    loadAdminSessions();
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            document.getElementById('visitorCinemaSelect').addEventListener('change', loadVisitorSessions);
            document.getElementById('adminCinemaSelect').addEventListener('change', updateAdminHalls);
            document.getElementById('createSessionBtn').addEventListener('click', createSession);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–æ–≤
        function updateCinemaSelects() {
            const visitorSelect = document.getElementById('visitorCinemaSelect');
            const adminSelect = document.getElementById('adminCinemaSelect');

            visitorSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä</option>';
            adminSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä</option>';

            cinemas.forEach(cinema => {
                visitorSelect.innerHTML += `<option value="${cinema.id}">${cinema.name}</option>`;
                adminSelect.innerHTML += `<option value="${cinema.id}">${cinema.name}</option>`;
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ–ª–∏
        function switchRole(role) {
            if (role === 'admin') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è
                document.getElementById('adminLoginModal').classList.add('active');
                return;
            }
            
            currentRole = role;
            
            
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            if (role === 'visitor') {
                document.querySelector('.role-btn[onclick="switchRole(\'visitor\')"]').classList.add('active');
                document.getElementById('visitorSection').classList.add('active');
                loadVisitorSessions();
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        function checkAdminPassword() {
            const password = document.getElementById('adminPasswordInput').value;
            
            if (password === '123234') {
                // –ü–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                currentRole = 'admin';
                
                
                document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                
                document.querySelector('.role-btn[onclick="switchRole(\'admin\')"]').classList.add('active');
                document.getElementById('adminSection').classList.add('active');
                loadAdminSessions();
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –æ—á–∏—â–∞–µ–º –ø–∞—Ä–æ–ª—å
                document.getElementById('adminLoginModal').classList.remove('active');
                document.getElementById('adminPasswordInput').value = '';
                
                showMessage('–î–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω', 'success');
            } else {
                showMessage('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!', 'error');
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminPasswordInput').focus();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–∞–Ω—Å–æ–≤ –¥–ª—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
        function loadVisitorSessions() {
            const cinemaId = document.getElementById('visitorCinemaSelect').value;
            const sessionsGrid = document.getElementById('sessionsGrid');

            if (!cinemaId) {
                sessionsGrid.innerHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä</p>';
                return;
            }

            const cinemaSessions = sessions.filter(s => s.cinema_id == cinemaId);
            const cinema = cinemas.find(c => c.id == cinemaId);

            if (cinemaSessions.length === 0) {
                sessionsGrid.innerHTML = '<p>–í —ç—Ç–æ–º –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–µ–∞–Ω—Å–æ–≤</p>';
                return;
            }

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–µ–∞–Ω—Å–æ–≤ –ø–æ —Ñ–∏–ª—å–º–∞–º –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const movies = {};
            cinemaSessions.forEach(session => {
                if (!movies[session.movie_title]) {
                    movies[session.movie_title] = [];
                }
                movies[session.movie_title].push(session);
            });

            let html = `<h3>${cinema.name}</h3>`;
            
            for (const [movieTitle, movieSessions] of Object.entries(movies)) {
                html += `
                    <div class="movie-card">
                        <h4>${movieTitle}</h4>
                        <div class="sessions-list">
                `;
                
                movieSessions.forEach(session => {
                    const hall = halls.find(h => h.id === session.hall_id);
                    const dateStr = session.session_date || '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
                    const timeStr = session.start_time || '–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
                    
                    html += `
                        <div class="session-card" onclick="selectSession(${session.id})">
                            <div class="session-info">
                                <strong>${dateStr} ${timeStr}</strong><br>
                                –ó–∞–ª: ${hall ? hall.name : '–ó–∞–ª ' + session.hall_id}<br>
                                –¶–µ–Ω–∞: ${session.price} ‚ÇΩ
                            </div>
                            <button class="btn">–í—ã–±—Ä–∞—Ç—å</button>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }

            sessionsGrid.innerHTML = html;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–∞–Ω—Å–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
        function loadAdminSessions() {
            const tbody = document.getElementById('adminSessionsTable');
            tbody.innerHTML = '';

            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç —Å–µ–∞–Ω—Å–æ–≤</td></tr>';
                return;
            }

            sessions.forEach(session => {
                const cinema = cinemas.find(c => c.id === session.cinema_id);
                const hall = halls.find(h => h.id === session.hall_id);
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞—Ç—ã
                const dateStr = session.session_date || '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
                const timeStr = session.start_time || '–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${session.id}</td>
                    <td>${session.movie_title}</td>
                    <td>${cinema ? cinema.name : '–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä ' + session.cinema_id}</td>
                    <td>${hall ? hall.name : '–ó–∞–ª ' + session.hall_id}</td>
                    <td>${dateStr}</td>
                    <td>${timeStr}</td>
                    <td>${session.price} ‚ÇΩ</td>
                    <td>
                        <button class="btn danger" onclick="deleteSession(${session.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ª–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
        function updateAdminHalls() {
            const cinemaId = document.getElementById('adminCinemaSelect').value;
            const hallSelect = document.getElementById('adminHallSelect');
            
            hallSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ª</option>';
            
            if (!cinemaId) return;
            
            const cinemaHalls = halls.filter(h => h.cinema_id == cinemaId);
            cinemaHalls.forEach(hall => {
                hallSelect.innerHTML += `<option value="${hall.id}">${hall.name} (${hall.rows}x${hall.seats_per_row})</option>`;
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∞–Ω—Å–∞
        async function createSession() {
            const cinemaId = document.getElementById('adminCinemaSelect').value;
            const hallId = document.getElementById('adminHallSelect').value;
            const movieTitle = document.getElementById('movieTitle').value;
            const sessionDate = document.getElementById('sessionDate').value;
            const sessionTime = document.getElementById('sessionTime').value;
            const price = document.getElementById('ticketPrice').value;

            if (!cinemaId || !hallId || !movieTitle || !sessionDate || !sessionTime || !price) {
                showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å–µ–∞–Ω—Å–æ–≤ –≤ —Ç–æ–º –∂–µ –∑–∞–ª–µ –≤ —Ç–æ –∂–µ –≤—Ä–µ–º—è
            const conflictingSession = sessions.find(session => 
                session.cinema_id == cinemaId && 
                session.hall_id == hallId && 
                session.session_date === sessionDate && 
                session.start_time === sessionTime
            );

            if (conflictingSession) {
                showMessage(`–ö–æ–Ω—Ñ–ª–∏–∫—Ç! –í –∑–∞–ª–µ ${halls.find(h => h.id == hallId)?.name || hallId} —É–∂–µ –µ—Å—Ç—å —Å–µ–∞–Ω—Å —Ñ–∏–ª—å–º–∞ "${conflictingSession.movie_title}" –≤ ${sessionTime} ${sessionDate}`, 'error');
                return;
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ - —Ä–∞–∑–¥–µ–ª—è–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
            const startDateTime = `${sessionDate}T${sessionTime}:00`;

            try {
                const response = await fetch(`${API_BASE}/api/session/sessions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        movie_title: movieTitle,
                        cinema_id: parseInt(cinemaId),
                        hall_id: parseInt(hallId),
                        session_date: sessionDate,
                        start_time: sessionTime,
                        price: parseFloat(price)
                    })
                });

                if (response.ok) {
                    showMessage('–°–µ–∞–Ω—Å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                    clearSessionForm();
                    await loadData();
                } else {
                    const error = await response.json();
                    showMessage('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–∞–Ω—Å–∞: ' + error.message, 'error');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞
        async function deleteSession(sessionId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–µ–∞–Ω—Å?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/session/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('–°–µ–∞–Ω—Å —É–¥–∞–ª–µ–Ω', 'success');
                    await loadData();
                } else {
                    showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞', 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –í—ã–±–æ—Ä —Å–µ–∞–Ω—Å–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –±–∏–ª–µ—Ç–æ–≤
        async function selectSession(sessionId) {
            selectedSession = sessions.find(s => s.id === sessionId);
            if (!selectedSession) return;

            const modal = document.getElementById('seatSelectionModal');
            const hall = halls.find(h => h.id === selectedSession.hall_id);
            
            document.getElementById('selectedMovie').textContent = selectedSession.movie_title;
            document.getElementById('selectedDateTime').textContent = `${selectedSession.session_date || '–î–∞—Ç–∞'} ${selectedSession.start_time || '–í—Ä–µ–º—è'}`;
            document.getElementById('selectedPrice').textContent = selectedSession.price + ' ‚ÇΩ';
            
            await generateSeatMap(hall);
            modal.classList.add('active');
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –º–µ—Å—Ç
        async function generateSeatMap(hall) {
            const seatMap = document.getElementById('seatMap');
            seatMap.innerHTML = '';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ –º–µ—Å—Ç–∞ –∏–∑ ticket-service
            let occupiedSeats = [];
            let soldSeats = [];
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –±–∏–ª–µ—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ–∞–Ω—Å–∞
                const response = await fetch(`${TICKET_API_BASE}/tickets/session/${selectedSession.id}`);
                if (response.ok) {
                    const tickets = await response.json();
                    // –ú–µ—Å—Ç–∞ –∑–∞–Ω—è—Ç—ã –µ—Å–ª–∏ –±–∏–ª–µ—Ç –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å RESERVED –∏–ª–∏ SOLD
                    occupiedSeats = tickets.filter(ticket => 
                        ticket.status === 'RESERVED' || ticket.status === 'SOLD'
                    ).map(ticket => `${ticket.row}-${ticket.number}`);
                    
                    // –û—Ç–¥–µ–ª—å–Ω–æ —Å–æ–±–∏—Ä–∞–µ–º –∫—É–ø–ª–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞
                    soldSeats = tickets.filter(ticket => 
                        ticket.status === 'SOLD'
                    ).map(ticket => `${ticket.row}-${ticket.number}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–ª–µ—Ç–æ–≤:', error);
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±—É–∫–≤–µ–Ω–Ω—ã–µ —Ä—è–¥—ã: A, B, C, ...
            for (let rowIndex = 0; rowIndex < hall.rows; rowIndex++) {
                const rowLetter = String.fromCharCode(65 + rowIndex); // 65 = 'A'
                const rowDiv = document.createElement('div');
                rowDiv.className = 'seat-row';
                
                for (let seat = 1; seat <= hall.seats_per_row; seat++) {
                    const seatBtn = document.createElement('button');
                    const seatId = `${rowLetter}-${seat}`;
                    
                    seatBtn.className = 'seat';
                    if (occupiedSeats.includes(seatId)) {
                        seatBtn.classList.add('occupied');
                        seatBtn.disabled = true;
                        seatBtn.title = '–ú–µ—Å—Ç–æ –∑–∞–Ω—è—Ç–æ';
                    }
                    
                    // –û—Å–æ–±—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç
                    if (soldSeats.includes(seatId)) {
                        seatBtn.classList.add('sold');
                        seatBtn.disabled = true;
                        seatBtn.title = '–ú–µ—Å—Ç–æ –∫—É–ø–ª–µ–Ω–æ';
                    }
                    
                    seatBtn.textContent = seatId;
                    seatBtn.onclick = () => toggleSeat(rowLetter, seat);
                    seatBtn.id = `seat-${rowLetter}-${seat}`;
                    rowDiv.appendChild(seatBtn);
                }
                
                seatMap.appendChild(rowDiv);
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç–∞
        function toggleSeat(row, seat) {
            const seatBtn = document.getElementById(`seat-${row}-${seat}`);
            
            if (seatBtn.classList.contains('occupied')) {
                return;
            }

            if (seatBtn.classList.contains('selected')) {
                seatBtn.classList.remove('selected');
                cart = cart.filter(item => !(item.row === row && item.seat === seat));
            } else {
                seatBtn.classList.add('selected');
                cart.push({ row, seat, price: selectedSession.price });
            }

            updateCart();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
        function updateCart() {
            const cartDiv = document.getElementById('cart');
            const totalPrice = cart.reduce((sum, item) => sum + item.price, 0);
            
            document.getElementById('cartCount').textContent = cart.length;
            document.getElementById('cartTotal').textContent = totalPrice + ' ‚ÇΩ';
            
            if (cart.length > 0) {
                cartDiv.style.display = 'block';
            } else {
                cartDiv.style.display = 'none';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            cart = [];
            selectedSession = null;
            updateCart();
        }

        // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // –û–ø–ª–∞—Ç–∞ –±–∏–ª–µ—Ç–æ–≤
        async function payment() {
            if (cart.length === 0) {
                showMessage('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã', 'error');
                return;
            }

            const email = document.getElementById('purchaseEmail').value;
            if (!email) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –ø–æ–∫—É–ø–∫–∏', 'error');
                return;
            }

            try {
                // –°–Ω–∞—á–∞–ª–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –≤—Å–µ –±–∏–ª–µ—Ç—ã
                const tickets = [];
                for (const item of cart) {
                    const ticketData = {
                        session_id: selectedSession.id,
                        row: item.row.toString(),
                        number: item.seat.toString(),
                        price: item.price,
                        email: email
                    };

                    const response = await fetch(`${TICKET_API_BASE}/api/ticket/tickets/reserve`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(ticketData)
                    });

                    if (response.ok) {
                        const ticket = await response.json();
                        tickets.push(ticket);
                    } else {
                        const error = await response.json();
                        showMessage('–û—à–∏–±–∫–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Å—Ç–∞ ' + item.row + '-' + item.seat + ': ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                        return;
                    }
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä—É–ø–ø–æ–≤—É—é –æ–ø–ª–∞—Ç—É –¥–ª—è –≤—Å–µ—Ö –±–∏–ª–µ—Ç–æ–≤ —Å—Ä–∞–∑—É
                const ticketIds = tickets.map(t => t.id);
                const totalAmount = tickets.reduce((sum, t) => sum + t.price, 0);
                
                const bulkPaymentResponse = await fetch(`${PAYMENT_API_BASE}/api/payment/bulk-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        ticket_ids: ticketIds,
                        total_amount: totalAmount,
                        email: email
                    })
                });

                if (bulkPaymentResponse.ok) {
                    const bulkPaymentResult = await bulkPaymentResponse.json();
                    if (bulkPaymentResult.status === 'SUCCESS') {
                        // –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –±–∏–ª–µ—Ç–æ–≤
                        showMessage(bulkPaymentResult.message, 'success');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –±–∏–ª–µ—Ç–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ
                        tickets.forEach(ticket => {
                            ticket.status = 'SOLD';
                        });
                        
                        const soldTickets = tickets;
                        
                        // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞
                        cart = [];
                        updateCart();
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É –º–µ—Å—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç
                        await generateSeatMap(halls.find(h => h.id === selectedSession.hall_id));
                    } else {
                        // –û–ø–ª–∞—Ç–∞ –Ω–µ—É—Å–ø–µ—à–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –±–∏–ª–µ—Ç–æ–≤
                        showMessage(bulkPaymentResult.message, 'error');
                        // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É, —Ç–∞–∫ –∫–∞–∫ –≤—Å–µ –±–∏–ª–µ—Ç—ã –æ—Ç–º–µ–Ω–µ–Ω—ã
                        cart = [];
                        updateCart();
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É –º–µ—Å—Ç
                        await generateSeatMap(halls.find(h => h.id === selectedSession.hall_id));
                    }
                } else {
                    const error = await bulkPaymentResponse.json();
                    showMessage('–û—à–∏–±–∫–∞ –≥—Ä—É–ø–ø–æ–≤–æ–π –æ–ø–ª–∞—Ç—ã: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ' + error.message, 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–ª–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadMyTickets() {
            const email = document.getElementById('emailInput').value;
            const myTicketsGrid = document.getElementById('myTicketsGrid');
            
            if (!email) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–∏–ª–µ—Ç–æ–≤', 'error');
                return;
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –±–∏–ª–µ—Ç—ã
                const response = await fetch(`${TICKET_API_BASE}/tickets`);
                if (response.ok) {
                    const allTickets = await response.json();
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –±–∏–ª–µ—Ç—ã –ø–æ email –∏ —Å—Ç–∞—Ç—É—Å—É SOLD
                    const myTickets = allTickets.filter(ticket => 
                        ticket.email === email && ticket.status === 'SOLD'
                    );

                    if (myTickets.length === 0) {
                        myTicketsGrid.innerHTML = '<p>–£ –≤–∞—Å –Ω–µ—Ç –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤</p>';
                        return;
                    }

                    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –±–∏–ª–µ—Ç—ã –ø–æ —Å–µ–∞–Ω—Å–∞–º
                    const ticketsBySession = {};
                    myTickets.forEach(ticket => {
                        if (!ticketsBySession[ticket.session_id]) {
                            ticketsBySession[ticket.session_id] = [];
                        }
                        ticketsBySession[ticket.session_id].push(ticket);
                    });

                    let html = '';
                    for (const [sessionId, tickets] of Object.entries(ticketsBySession)) {
                        const session = sessions.find(s => s.id == sessionId);
                        if (session) {
                            html += `
                                <div class="movie-card">
                                    <h4>${session.movie_title}</h4>
                                    <p><strong>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</strong> ${session.session_date || '–î–∞—Ç–∞'} ${session.start_time || '–í—Ä–µ–º—è'}</p>
                                    <p><strong>–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä:</strong> ${cinemas.find(c => c.id === session.cinema_id)?.name || '–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä ' + session.cinema_id}</p>
                                    <div style="margin-bottom: 15px;">
                                        <strong>–ë–∏–ª–µ—Ç—ã:</strong>
                                        ${tickets.map(ticket => `
                                            <div style="background: rgba(255,255,255,0.1); padding: 8px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                                                <span>–ú–µ—Å—Ç–æ ${ticket.row}-${ticket.number} - ${ticket.price} ‚ÇΩ</span>
                                                <button class="btn" style="background: #ff9800; padding: 5px 10px; font-size: 12px;" onclick="returnTicket(${ticket.id})">–í–µ—Ä–Ω—É—Ç—å</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <button class="btn" onclick="returnAllSessionTickets(${sessionId})">–í–µ—Ä–Ω—É—Ç—å –≤—Å–µ –±–∏–ª–µ—Ç—ã —Å–µ–∞–Ω—Å–∞</button>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    myTicketsGrid.innerHTML = html;
                } else {
                    showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–ª–µ—Ç–æ–≤', 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –í–æ–∑–≤—Ä–∞—Ç –æ–¥–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞
        async function returnTicket(ticketId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å —ç—Ç–æ—Ç –±–∏–ª–µ—Ç?')) {
                return;
            }

            try {
                const response = await fetch(`${PAYMENT_API_BASE}/payment/refund`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        ticket_id: ticketId,
                        reason: "–í–æ–∑–≤—Ä–∞—Ç –ø–æ –ø—Ä–æ—Å—å–±–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage(result.message || '–ë–∏–ª–µ—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω', 'success');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –±–∏–ª–µ—Ç–æ–≤
                    await loadMyTickets();
                } else {
                    const error = await response.json();
                    showMessage('–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –±–∏–ª–µ—Ç–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –í–æ–∑–≤—Ä–∞—Ç –≤—Å–µ—Ö –±–∏–ª–µ—Ç–æ–≤ —Å–µ–∞–Ω—Å–∞
        async function returnAllSessionTickets(sessionId) {
            const email = document.getElementById('emailInput').value;
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ –±–∏–ª–µ—Ç—ã —ç—Ç–æ–≥–æ —Å–µ–∞–Ω—Å–∞?')) {
                return;
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –±–∏–ª–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ–∞–Ω—Å–∞
                const response = await fetch(`${TICKET_API_BASE}/tickets`);
                if (response.ok) {
                    const allTickets = await response.json();
                    const sessionTickets = allTickets.filter(ticket => 
                        ticket.email === email && 
                        ticket.session_id === sessionId && 
                        ticket.status === 'SOLD'
                    );

                    if (sessionTickets.length === 0) {
                        showMessage('–ù–µ—Ç –±–∏–ª–µ—Ç–æ–≤ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞', 'error');
                        return;
                    }

                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ –±–∏–ª–µ—Ç—ã
                    let returnedCount = 0;
                    for (const ticket of sessionTickets) {
                        try {
                            const cancelResponse = await fetch(`${TICKET_API_BASE}/tickets/cancel/${ticket.id}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                }
                            });

                            if (cancelResponse.ok) {
                                returnedCount++;
                            } else {
                                const error = await cancelResponse.json();
                                showMessage('–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –±–∏–ª–µ—Ç–∞ ' + ticket.row + '-' + ticket.number + ': ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                            }
                        } catch (error) {
                            showMessage('–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –±–∏–ª–µ—Ç–∞ ' + ticket.row + '-' + ticket.number + ': ' + error.message, 'error');
                        }
                    }

                    if (returnedCount > 0) {
                        showMessage(`–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –±–∏–ª–µ—Ç–æ–≤: ${returnedCount}`, 'success');
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –±–∏–ª–µ—Ç–æ–≤
                        await loadMyTickets();
                    }
                } else {
                    showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–ª–µ—Ç–æ–≤', 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–∞–Ω—Å–∞
        function clearSessionForm() {
            document.getElementById('movieTitle').value = '';
            document.getElementById('sessionDate').value = '';
            document.getElementById('sessionTime').value = '';
            document.getElementById('ticketPrice').value = '';
        }


        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤
        async function loadLogs() {
            const logsContent = document.getElementById('logsContent');
            logsContent.innerHTML = '<p style="color: #888;">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</p>';
            
            try {
                // –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (500 —Å—Ç—Ä–æ–∫)
                const response = await fetch(`${API_BASE}/api/monitoring/user-actions?lines=500`);
                if (response.ok) {
                    const data = await response.json();
                    displayUserActionLogs(data.logs || []);
                } else {
                    logsContent.innerHTML = '<p style="color: #f44336;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤</p>';
                }
            } catch (error) {
                logsContent.innerHTML = `<p style="color: #f44336;">–û—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ª–æ–≥–æ–≤
        async function clearLogs() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –í–°–ï –ª–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/monitoring/user-actions/clear`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('–í—Å–µ –ª–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã', 'success');
                    // –û—á–∏—â–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤
                    document.getElementById('logsContent').innerHTML = '<p style="color: #888;">–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π</p>';
                } else {
                    const error = await response.json();
                    showMessage('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function displayUserActionLogs(logs) {
            const logsContent = document.getElementById('logsContent');
            
            if (logs.length === 0) {
                logsContent.innerHTML = '<p style="color: #888;">–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            let logsHtml = '<div style="white-space: pre-wrap;">';
            logs.forEach(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('ru-RU');
                const action = getActionDisplay(log.action);
                const color = getActionColor(log.action);
                
                logsHtml += `<div style="margin-bottom: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 5px; border-left: 3px solid ${color};">
                    <div style="color: ${color}; font-weight: bold;">${action}</div>
                    <div style="color: #888; font-size: 12px;">${timestamp}</div>
                    <div style="color: #ccc;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${log.user_id}</div>`;
                
                if (log.details && Object.keys(log.details).length > 0) {
                    logsHtml += '<div style="margin-top: 5px; font-size: 12px;">';
                    Object.entries(log.details).forEach(([key, value]) => {
                        logsHtml += `<span style="color: #aaa;">${key}:</span> <span style="color: #fff;">${value}</span> `;
                    });
                    logsHtml += '</div>';
                }
                
                logsHtml += '</div>';
            });
            logsHtml += '</div>';
            
            logsContent.innerHTML = logsHtml;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
        function getActionDisplay(action) {
            const actions = {
                'CREATE_SESSION': 'üé¨ –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∞–Ω—Å–∞',
                'DELETE_SESSION': 'üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞',
                'RESERVE_TICKET': 'üé´ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–ª–µ—Ç–∞',
                'CONFIRM_TICKET': '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±–∏–ª–µ—Ç–∞',
                'CANCEL_TICKET': '‚ùå –û—Ç–º–µ–Ω–∞ –±–∏–ª–µ—Ç–∞',
                'PAYMENT_SUCCESS': 'üí∞ –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂',
                'PAYMENT_FAILED': 'üí∏ –ù–µ—É–¥–∞—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂',
                'PAYMENT_REFUND': 'üí≥ –í–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞',
                'BULK_PAYMENT_SUCCESS': 'üí∞ –ì—Ä—É–ø–ø–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞',
                'BULK_PAYMENT_FAILED': 'üí∏ –ì—Ä—É–ø–ø–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å'
            };
            return actions[action] || action;
        }

        function getActionColor(action) {
            const colors = {
                'CREATE_SESSION': '#4CAF50',
                'DELETE_SESSION': '#f44336',
                'RESERVE_TICKET': '#2196F3',
                'CONFIRM_TICKET': '#4CAF50',
                'CANCEL_TICKET': '#ff9800',
                'PAYMENT_SUCCESS': '#4CAF50',
                'PAYMENT_FAILED': '#f44336',
                'PAYMENT_REFUND': '#ff9800',
                'BULK_PAYMENT_SUCCESS': '#4CAF50',
                'BULK_PAYMENT_FAILED': '#f44336'
            };
            return colors[action] || '#ccc';
        }

    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .role-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .role-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .role-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .role-btn.active {
            background: #4CAF50;
            box-shadow: 0 4px 15px rgba(76,175,80,0.3);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group select option {
            background: #2a5298;
            color: #fff;
            padding: 10px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            background: rgba(255,255,255,0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: #4CAF50;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76,175,80,0.3);
        }

        .btn.danger {
            background: #f44336;
        }

        .btn.danger:hover {
            background: #da190b;
            box-shadow: 0 4px 15px rgba(244,67,54,0.3);
        }

        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .movie-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .movie-card h4 {
            margin-bottom: 15px;
            color: #4CAF50;
            font-size: 1.3em;
        }

        .sessions-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .session-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .session-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }

        .session-info {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        th {
            background: rgba(255,255,255,0.1);
            font-weight: 600;
            color: #4CAF50;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal-header h3 {
            font-size: 1.6em;
            margin-bottom: 8px;
            color: #4CAF50;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .seat-map {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .seat-row {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
            gap: 6px;
        }

        .seat {
            width: 35px;
            height: 35px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .seat:hover:not(.occupied) {
            background: rgba(76,175,80,0.4);
            border-color: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76,175,80,0.3);
        }

        .seat.selected {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-color: #45a049;
            box-shadow: 0 4px 8px rgba(76,175,80,0.4);
            transform: translateY(-2px);
        }

        .seat.occupied {
            background: linear-gradient(135deg, #f44336, #da190b);
            border-color: #da190b;
            cursor: not-allowed;
            opacity: 0.8;
            box-shadow: 0 2px 4px rgba(244,67,54,0.3);
        }

        .seat.sold {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            border-color: #f57c00;
            cursor: not-allowed;
            opacity: 0.9;
            box-shadow: 0 2px 4px rgba(255,152,0,0.3);
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .message.success {
            background: #4CAF50;
            color: #fff;
        }

        .message.error {
            background: #f44336;
            color: #fff;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            min-width: 220px;
            border: 2px solid #4CAF50;
            display: none;
            z-index: 999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .cart h4 {
            margin-bottom: 10px;
            color: #4CAF50;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .metric-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .metric-card h4 {
            margin-bottom: 10px;
            color: #e0e0e0;
            font-size: 0.9em;
            font-weight: 500;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
            <h1>üé¨ –°–∏—Å—Ç–µ–º–∞ –ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä–æ–≤</h1>
            <p>–£–¥–æ–±–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ –±–∏–ª–µ—Ç–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞–º–∏</p>
        </div>

        <div class="role-selector">
            <button class="role-btn active" onclick="switchRole('visitor')">üë§ –ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å</button>
            <button class="role-btn" onclick="switchRole('admin')">‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
        </div>

        <!-- –°–ï–ö–¶–ò–Ø –ü–û–°–ï–¢–ò–¢–ï–õ–Ø -->
        <div id="visitorSection" class="section active">
            <div class="card">
                <h2>–í—ã–±–æ—Ä —Å–µ–∞–Ω—Å–æ–≤</h2>
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä:</label>
                    <select id="visitorCinemaSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä</option>
                    </select>
                </div>
                <div id="sessionsGrid">
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–µ–∞–Ω—Å–æ–≤</p>
                </div>
            </div>

            <div class="card">
                <h2>–ú–æ–∏ –±–∏–ª–µ—Ç—ã</h2>
                <div class="form-group">
                    <label>Email –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–∏–ª–µ—Ç–æ–≤:</label>
                    <input type="email" id="emailInput" placeholder="customer@example.com" value="customer@example.com">
                    <button class="btn" onclick="loadMyTickets()" style="margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–ª–µ—Ç—ã</button>
                </div>
                <div id="myTicketsGrid">
                    <p>–í–≤–µ–¥–∏—Ç–µ email –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–ª–µ—Ç—ã"</p>
                </div>
            </div>
        </div>

        <!-- –°–ï–ö–¶–ò–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê -->
        <div id="adminSection" class="section">
            <div class="card">
                <h2>–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∞–Ω—Å–∞</h2>
                <div class="form-group">
                    <label>–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä:</label>
                    <select id="adminCinemaSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ó–∞–ª:</label>
                    <select id="adminHallSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ª</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞:</label>
                    <input type="text" id="movieTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>–î–∞—Ç–∞:</label>
                        <input type="date" id="sessionDate">
                    </div>
                    <div class="form-group">
                        <label>–í—Ä–µ–º—è:</label>
                        <select id="sessionTime">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</option>
                            <option value="10:00">10:00</option>
                            <option value="12:00">12:00</option>
                            <option value="14:00">14:00</option>
                            <option value="16:00">16:00</option>
                            <option value="18:00">18:00</option>
                            <option value="20:00">20:00</option>
                            <option value="22:00">22:00</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>–¶–µ–Ω–∞ –±–∏–ª–µ—Ç–∞ (‚ÇΩ):</label>
                    <input type="number" id="ticketPrice" placeholder="300" min="0">
                </div>
                <button class="btn" id="createSessionBtn">–°–æ–∑–¥–∞—Ç—å —Å–µ–∞–Ω—Å</button>
            </div>

            <div class="card">
                <h2>–¢–µ–∫—É—â–∏–µ —Å–µ–∞–Ω—Å—ã</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–§–∏–ª—å–º</th>
                            <th>–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä</th>
                            <th>–ó–∞–ª</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="adminSessionsTable">
                        <tr><td colspan="8" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="loadLogs()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏</button>
                    <button class="btn danger" onclick="clearLogs()" style="margin-left: 10px;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏</button>
                </div>
                
                <div id="logsContainer">
                    <h3>üìã –î–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div id="logsContent" style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; max-height: 600px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.4;">
                        <p style="color: #888;">–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 500 –∑–∞–ø–∏—Å–µ–π</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–´–ë–û–†–ê –ú–ï–°–¢ -->
        <div id="seatSelectionModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('seatSelectionModal')">√ó</button>
                <div class="modal-header">
                    <h3 id="selectedMovie">–§–∏–ª—å–º</h3>
                    <p id="selectedDateTime">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</p>
                    <p><strong>–¶–µ–Ω–∞:</strong> <span id="selectedPrice">0 ‚ÇΩ</span></p>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Email –¥–ª—è –ø–æ–∫—É–ø–∫–∏:</label>
                        <input type="email" id="purchaseEmail" placeholder="customer@example.com" value="customer@example.com" style="width: 100%; padding: 8px;">
                    </div>
                </div>
                <div class="seat-map">
                    <h4>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞:</h4>
                    <div id="seatMap"></div>
                </div>
                <div id="cart" style="display: none;">
                    <h4>–ö–æ—Ä–∑–∏–Ω–∞</h4>
                    <p>–ú–µ—Å—Ç: <span id="cartCount">0</span></p>
                    <p>–ò—Ç–æ–≥–æ: <span id="cartTotal">0 ‚ÇΩ</span></p>
                    <button class="btn" style="width: 100%; margin-top: 10px;" onclick="payment()">–û–ø–ª–∞—Ç–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–•–û–î–ê –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê -->
        <div id="adminLoginModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <button class="close-btn" onclick="closeModal('adminLoginModal')">√ó</button>
                <div class="modal-header">
                    <h3>üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
                    <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
                </div>
                <div class="form-group">
                    <label for="adminPasswordInput">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="adminPasswordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" 
                           onkeypress="if(event.key === 'Enter') checkAdminPassword()" 
                           style="width: 100%; padding: 12px;">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" onclick="checkAdminPassword()" style="flex: 1;">–í–æ–π—Ç–∏</button>
                    <button class="btn danger" onclick="closeModal('adminLoginModal')" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                </div>
                <p style="margin-top: 15px; font-size: 12px; color: #888; text-align: center;">
                    –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–∞—Ä–æ–ª—å - 123234
                </p>
            </div>
        </div>
    </div>
</body>
</html>
